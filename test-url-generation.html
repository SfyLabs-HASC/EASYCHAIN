<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test URL Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .url-test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Test URL Generation</h1>
        <p>Questo test verifica come vengono generati gli URL dei certificati.</p>
        
        <div class="test-section">
            <h3>üìã Informazioni Correnti</h3>
            <div id="current-info"></div>
        </div>
        
        <div class="test-section">
            <h3>üß™ Test Generazione URL</h3>
            <button onclick="testURLGeneration()">Test URL Generation</button>
            <div id="url-test-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç Test URL Esistenti</h3>
            <button onclick="testExistingURLs()">Test Existing URLs</button>
            <div id="existing-urls"></div>
        </div>
    </div>

    <script>
        // Mostra informazioni correnti
        function displayCurrentInfo() {
            const info = {
                'window.location.origin': window.location.origin,
                'window.location.hostname': window.location.hostname,
                'window.location.protocol': window.location.protocol,
                'window.location.port': window.location.port,
                'window.location.pathname': window.location.pathname,
                'navigator.userAgent': navigator.userAgent.substring(0, 100) + '...'
            };
            
            const container = document.getElementById('current-info');
            let html = '<pre>';
            for (const [key, value] of Object.entries(info)) {
                html += `${key}: ${value}\n`;
            }
            html += '</pre>';
            container.innerHTML = html;
        }
        
        // Test generazione URL
        window.testURLGeneration = async function() {
            const container = document.getElementById('url-test-results');
            container.innerHTML = '<p>üîÑ Testando generazione URL...</p>';
            
            try {
                // Simula la generazione di un certificato
                const testBatchId = 'test_' + Date.now();
                const certificateId = `${testBatchId}_${Date.now()}`;
                
                // Testa diversi modi di generare l'URL
                const baseUrl1 = window.location.origin;
                const baseUrl2 = `${window.location.protocol}//${window.location.hostname}`;
                const baseUrl3 = `${window.location.protocol}//${window.location.hostname}:${window.location.port}`;
                
                const urls = [
                    {
                        name: 'window.location.origin',
                        url: `${baseUrl1}/api/qr-system?action=view&id=${certificateId}`
                    },
                    {
                        name: 'protocol + hostname',
                        url: `${baseUrl2}/api/qr-system?action=view&id=${certificateId}`
                    },
                    {
                        name: 'protocol + hostname + port',
                        url: `${baseUrl3}/api/qr-system?action=view&id=${certificateId}`
                    }
                ];
                
                let html = '<div class="url-test">';
                html += '<h4>URL Generati:</h4>';
                for (const urlInfo of urls) {
                    html += `<p><strong>${urlInfo.name}:</strong><br>`;
                    html += `<code>${urlInfo.url}</code><br>`;
                    html += `<a href="${urlInfo.url}" target="_blank">Test Link</a></p>`;
                }
                html += '</div>';
                
                // Testa se l'API risponde
                html += '<div class="url-test">';
                html += '<h4>Test API Response:</h4>';
                
                for (const urlInfo of urls) {
                    try {
                        const response = await fetch(urlInfo.url);
                        const status = response.ok ? '‚úÖ' : '‚ùå';
                        html += `<p>${status} ${urlInfo.name}: ${response.status} ${response.statusText}</p>`;
                    } catch (error) {
                        html += `<p>‚ùå ${urlInfo.name}: ${error.message}</p>`;
                    }
                }
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `
                    <div class="test-section error">
                        <h4>‚ùå Errore</h4>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        };
        
        // Test URL esistenti
        window.testExistingURLs = async function() {
            const container = document.getElementById('existing-urls');
            container.innerHTML = '<p>üîÑ Testando URL esistenti...</p>';
            
            // Lista di URL di test comuni
            const testUrls = [
                '/api/qr-system?action=test',
                '/api/qr-system?action=view&id=test_123',
                '/api/qr-system?action=view&id=85_1757759154982'
            ];
            
            let html = '<div class="url-test">';
            html += '<h4>Test URL Esistenti:</h4>';
            
            for (const testUrl of testUrls) {
                const fullUrl = window.location.origin + testUrl;
                try {
                    const response = await fetch(fullUrl);
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    html += `<p>${status} <a href="${fullUrl}" target="_blank">${testUrl}</a> - ${response.status} ${response.statusText}</p>`;
                } catch (error) {
                    html += `<p>‚ùå <a href="${fullUrl}" target="_blank">${testUrl}</a> - ${error.message}</p>`;
                }
            }
            html += '</div>';
            
            container.innerHTML = html;
        };
        
        // Inizializza
        displayCurrentInfo();
    </script>
</body>
</html>